{% extends "core/base.html" %}
{% load query_params %}

{% block title %}Search Recipes - Cookmarks{% endblock %}

{% block content %}
<style>
    /* Search page styles */
    .search-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .search-box {
        background: #fff;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        margin-bottom: 1rem;
    }
    
    .search-box-title {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #6c757d;
        margin-bottom: 0.75rem;
        display: block;
    }
    
    /* Quick search */
    .quick-search-input {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    .quick-search-input:focus {
        outline: none;
        border-color: #212529;
        box-shadow: 0 0 0 3px rgba(33, 37, 41, 0.1);
    }
    
    /* Filter groups */
    .filter-group {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 0.875rem;
        margin-bottom: 0.5rem;
        background: #fafbfc;
    }
    
    .filter-group-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .filter-group-label {
        font-size: 0.75rem;
        color: #6c757d;
        flex: 1;
    }
    
    .filter-group-logic {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        border: none;
        border-radius: 4px;
        background: #e9ecef;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .filter-group-logic:hover {
        background: #dee2e6;
    }
    
    .filter-group-logic.and {
        background: #d4edda;
        color: #155724;
    }
    
    .filter-group-logic.or {
        background: #cce5ff;
        color: #004085;
    }
    
    .filter-row {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        align-items: center;
    }
    
    .filter-row:last-child {
        margin-bottom: 0;
    }
    
    .filter-field-select {
        min-width: 120px;
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
        border: 1px solid #e9ecef;
        border-radius: 6px;
    }
    
    .filter-operator-select {
        min-width: 100px;
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
        border: 1px solid #e9ecef;
        border-radius: 6px;
    }
    
    .filter-value-input {
        flex: 1;
        padding: 0.4rem 0.6rem;
        font-size: 0.85rem;
        border: 1px solid #e9ecef;
        border-radius: 6px;
    }
    
    .filter-remove-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border: none;
        border-radius: 4px;
        background: #f8f9fa;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .filter-remove-btn:hover {
        background: #dc3545;
        color: white;
    }
    
    .filter-add-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.75rem;
        font-size: 0.8rem;
        border: 1px dashed #dee2e6;
        border-radius: 6px;
        background: transparent;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .filter-add-btn:hover {
        border-color: #212529;
        color: #212529;
        background: #f8f9fa;
    }
    
    .filter-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    /* Logic connector between groups */
    .logic-connector {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem 0;
    }
    
    .logic-connector-btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        background: #fff;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .logic-connector-btn:hover {
        background: #f8f9fa;
    }
    
    .logic-connector-btn.and {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    
    .logic-connector-btn.or {
        background: #cce5ff;
        border-color: #b8daff;
        color: #004085;
    }
    
    /* Search actions */
    .search-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }
    
    .search-btn {
        padding: 0.6rem 1.5rem;
        font-size: 0.9rem;
        font-weight: 500;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .search-btn-primary {
        background: #212529;
        color: white;
    }
    
    .search-btn-primary:hover {
        background: #343a40;
    }
    
    .search-btn-secondary {
        background: transparent;
        border: 1px solid #dee2e6;
        color: #495057;
    }
    
    .search-btn-secondary:hover {
        background: #f8f9fa;
    }
    
    /* Results */
    .search-results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .search-results-count {
        font-size: 0.9rem;
        color: #6c757d;
    }
    
    .search-results-sort {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* Recipe result card */
    .result-card {
        display: block;
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        text-decoration: none;
        color: inherit;
        transition: all 0.15s ease;
    }
    
    .result-card:hover {
        border-color: #dee2e6;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transform: translateY(-1px);
    }
    
    .result-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .result-card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #212529;
        margin: 0;
    }
    
    .result-card-meta {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .result-card-source {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        font-size: 0.8rem;
        color: #6c757d;
        text-align: right;
    }
    
    .result-card-author {
        font-weight: 500;
        color: #495057;
    }
    
    .result-card-highlights {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin-top: 0.75rem;
    }
    
    .highlight-tag {
        display: inline-block;
        background: #fff3cd;
        border: 1px solid #ffc107;
        color: #856404;
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
    }
    
    .result-card-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin-top: 0.5rem;
    }
    
    .result-keyword {
        display: inline-block;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        color: #495057;
        font-size: 0.75rem;
        padding: 0.15rem 0.5rem;
        border-radius: 10px;
    }
    
    /* Match highlight in text */
    .match {
        background: #fff3cd;
        padding: 0 0.15rem;
        border-radius: 2px;
    }
    
    /* Empty state */
    .search-empty {
        text-align: center;
        padding: 4rem 2rem;
        color: #6c757d;
    }
    
    .search-empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
</style>

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Search Recipes</h1>
</div>

<div class="search-container">
    <form method="get" action="{% url 'search' %}" id="searchForm">
        <!-- Quick Search Box -->
        <div class="search-box">
            <input type="text" 
                   class="quick-search-input" 
                   name="q" 
                   placeholder="Search all fields (fuzzy matching)..." 
                   value="{{ query }}"
                   autofocus>
        </div>
        
        <!-- Advanced Filter Builder -->
        <div class="search-box">
            <div class="search-box-title">Advanced Filters</div>
            <div id="filterGroups">
                {% if filters %}
                    {% for group in filters %}
                    <div class="filter-group" data-group-index="{{ forloop.counter0 }}">
                        <div class="filter-group-header">
                            <button type="button" class="filter-group-logic {{ group.logic }}" onclick="toggleGroupLogic(this)">{{ group.logic|upper }}</button>
                            <span class="filter-group-label">within this group</span>
                            <button type="button" class="filter-remove-btn" onclick="removeGroup(this)" title="Remove group">√ó</button>
                        </div>
                        {% for condition in group.conditions %}
                        <div class="filter-row">
                            <select class="filter-field-select" name="filter_field[]">
                                <option value="name" {% if condition.field == 'name' %}selected{% endif %}>Name</option>
                                <option value="ingredients" {% if condition.field == 'ingredients' %}selected{% endif %}>Ingredients</option>
                                <option value="instructions" {% if condition.field == 'instructions' %}selected{% endif %}>Instructions</option>
                                <option value="keywords" {% if condition.field == 'keywords' %}selected{% endif %}>Keywords</option>
                                <option value="author" {% if condition.field == 'author' %}selected{% endif %}>Author</option>
                                <option value="book" {% if condition.field == 'book' %}selected{% endif %}>Book</option>
                            </select>
                            <select class="filter-operator-select" name="filter_op[]">
                                <option value="contains" {% if condition.op == 'contains' %}selected{% endif %}>contains</option>
                                <option value="not_contains" {% if condition.op == 'not_contains' %}selected{% endif %}>doesn't contain</option>
                                <option value="equals" {% if condition.op == 'equals' %}selected{% endif %}>equals</option>
                                <option value="starts" {% if condition.op == 'starts' %}selected{% endif %}>starts with</option>
                            </select>
                            <input type="text" class="filter-value-input" name="filter_value[]" value="{{ condition.value }}" placeholder="Value...">
                            <input type="hidden" name="filter_group[]" value="{{ forloop.parentloop.counter0 }}">
                            <input type="hidden" name="filter_logic[]" value="{{ group.logic }}">
                            <button type="button" class="filter-remove-btn" onclick="removeFilter(this)" title="Remove filter">√ó</button>
                        </div>
                        {% endfor %}
                        <button type="button" class="filter-add-btn mt-2" onclick="addFilterToGroup(this.parentElement)">+ Add condition</button>
                    </div>
                    {% if not forloop.last %}
                    <div class="logic-connector">
                        <button type="button" class="logic-connector-btn {{ group_logic|default:'or' }}" onclick="toggleConnectorLogic(this)">{{ group_logic|default:'OR'|upper }}</button>
                    </div>
                    {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
            <input type="hidden" name="group_logic" id="groupLogicInput" value="{{ group_logic|default:'or' }}">
            <button type="button" class="filter-add-btn {% if filters %}mt-3{% endif %}" onclick="addFilterGroup()">+ Add filter group</button>
        </div>
        
        <!-- Sort -->
        <input type="hidden" name="sort" id="sortInput" value="{{ sort_by|default:'relevance' }}">
        
        <!-- Search Actions -->
        <div class="search-actions">
            <a href="{% url 'search' %}" class="search-btn search-btn-secondary">Clear All</a>
            <button type="submit" class="search-btn search-btn-primary">Search</button>
        </div>
    </form>
    
    <!-- Search Results -->
    {% if has_searched %}
    <div class="search-results mt-4">
        <div class="search-results-header">
            <span class="search-results-count">
                {{ recipes.paginator.count }} result{{ recipes.paginator.count|pluralize }}
                {% if query %}for "{{ query }}"{% endif %}
            </span>
            <div class="search-results-sort">
                <span style="font-size: 0.85rem; color: #6c757d;">Sort:</span>
                <select class="form-select form-select-sm" style="width: auto; font-size: 0.85rem;" id="sortSelect">
                    <option value="relevance" {% if sort_by == 'relevance' %}selected{% endif %}>Relevance</option>
                    <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name A-Z</option>
                    <option value="recent" {% if sort_by == 'recent' %}selected{% endif %}>Recently Added</option>
                    <option value="author" {% if sort_by == 'author' %}selected{% endif %}>Author</option>
                    <option value="book" {% if sort_by == 'book' %}selected{% endif %}>Book</option>
                </select>
            </div>
        </div>
        
        {% for recipe in recipes %}
        <a href="{% url 'recipe_detail' recipe.id %}?context=search&q={{ query|urlencode }}" class="result-card">
            <div class="result-card-header">
                <div>
                    <h3 class="result-card-title">{{ recipe.clean_name }}</h3>
                    {% if recipe.description %}
                    <p class="result-card-meta">{{ recipe.description|truncatewords:20 }}</p>
                    {% endif %}
                </div>
                <div class="result-card-source">
                    <span class="result-card-author">{{ recipe.book.author }}</span>
                    <span>{{ recipe.book.clean_title }}</span>
                </div>
            </div>
            {% if recipe.match_highlights %}
            <div class="result-card-highlights">
                {% for highlight in recipe.match_highlights %}
                <span class="highlight-tag">{{ highlight }}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% if recipe.keywords.all %}
            <div class="result-card-keywords">
                {% for keyword in recipe.keywords.all|slice:":8" %}
                <span class="result-keyword">{{ keyword.name }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </a>
        {% empty %}
        <div class="search-empty">
            <div class="search-empty-icon">üîç</div>
            <h3>No recipes found</h3>
            <p>Try adjusting your search terms or filters</p>
        </div>
        {% endfor %}
        
        <!-- Pagination -->
        {% if recipes.has_other_pages %}
        <nav class="page-pagination" aria-label="Search results pagination">
            {% if recipes.has_previous %}
            <a href="{% preserve_query_params page=1 %}" class="pagination-btn" title="First page">¬´¬´</a>
            <a href="{% preserve_query_params page=recipes.previous_page_number %}" class="pagination-btn" title="Previous page">‚Äπ</a>
            {% endif %}
            
            <span class="pagination-info">
                Page {{ recipes.number }} of {{ recipes.paginator.num_pages }}
            </span>
            
            {% if recipes.has_next %}
            <a href="{% preserve_query_params page=recipes.next_page_number %}" class="pagination-btn" title="Next page">‚Ä∫</a>
            <a href="{% preserve_query_params page=recipes.paginator.num_pages %}" class="pagination-btn" title="Last page">¬ª¬ª</a>
            {% endif %}
        </nav>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
let groupCounter = {{ filters|length|default:0 }};

function createFilterRow(groupIndex, logic) {
    const row = document.createElement('div');
    row.className = 'filter-row';
    row.innerHTML = `
        <select class="filter-field-select" name="filter_field[]">
            <option value="name">Name</option>
            <option value="ingredients">Ingredients</option>
            <option value="instructions">Instructions</option>
            <option value="keywords">Keywords</option>
            <option value="author">Author</option>
            <option value="book">Book</option>
        </select>
        <select class="filter-operator-select" name="filter_op[]">
            <option value="contains">contains</option>
            <option value="not_contains">doesn't contain</option>
            <option value="equals">equals</option>
            <option value="starts">starts with</option>
        </select>
        <input type="text" class="filter-value-input" name="filter_value[]" placeholder="Value...">
        <input type="hidden" name="filter_group[]" value="${groupIndex}">
        <input type="hidden" name="filter_logic[]" value="${logic}">
        <button type="button" class="filter-remove-btn" onclick="removeFilter(this)" title="Remove filter">√ó</button>
    `;
    return row;
}

function addFilterGroup() {
    const container = document.getElementById('filterGroups');
    const existingGroups = container.querySelectorAll('.filter-group');
    
    // Add logic connector if not the first group
    if (existingGroups.length > 0) {
        const connector = document.createElement('div');
        connector.className = 'logic-connector';
        const currentLogic = document.getElementById('groupLogicInput').value || 'or';
        connector.innerHTML = `<button type="button" class="logic-connector-btn ${currentLogic}" onclick="toggleConnectorLogic(this)">${currentLogic.toUpperCase()}</button>`;
        container.appendChild(connector);
    }
    
    const group = document.createElement('div');
    group.className = 'filter-group';
    group.dataset.groupIndex = groupCounter;
    group.innerHTML = `
        <div class="filter-group-header">
            <button type="button" class="filter-group-logic and" onclick="toggleGroupLogic(this)">AND</button>
            <span class="filter-group-label">within this group</span>
            <button type="button" class="filter-remove-btn" onclick="removeGroup(this)" title="Remove group">√ó</button>
        </div>
    `;
    
    const filterRow = createFilterRow(groupCounter, 'and');
    group.appendChild(filterRow);
    
    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'filter-add-btn';
    addBtn.textContent = '+ Add condition';
    addBtn.onclick = function() { addFilterToGroup(group); };
    group.appendChild(addBtn);
    
    container.appendChild(group);
    groupCounter++;
}

function addFilterToGroup(groupElement) {
    const groupIndex = groupElement.dataset.groupIndex;
    const logicBtn = groupElement.querySelector('.filter-group-logic');
    const logic = logicBtn ? logicBtn.textContent.toLowerCase() : 'and';
    const addBtn = groupElement.querySelector('.filter-add-btn');
    const filterRow = createFilterRow(groupIndex, logic);
    groupElement.insertBefore(filterRow, addBtn);
}

function removeFilter(button) {
    const row = button.closest('.filter-row');
    const group = row.closest('.filter-group');
    row.remove();
    
    // If no more filter rows in group, remove the group
    if (group.querySelectorAll('.filter-row').length === 0) {
        removeGroupElement(group);
    }
}

function removeGroup(button) {
    const group = button.closest('.filter-group');
    removeGroupElement(group);
}

function removeGroupElement(group) {
    const container = document.getElementById('filterGroups');
    const groups = Array.from(container.querySelectorAll('.filter-group'));
    const index = groups.indexOf(group);
    
    // Remove associated connector
    const connectors = container.querySelectorAll('.logic-connector');
    if (index > 0 && connectors[index - 1]) {
        connectors[index - 1].remove();
    } else if (index === 0 && connectors[0]) {
        connectors[0].remove();
    }
    
    group.remove();
}

function toggleGroupLogic(button) {
    const group = button.closest('.filter-group');
    const isAnd = button.classList.contains('and');
    const newLogic = isAnd ? 'or' : 'and';
    
    button.classList.remove('and', 'or');
    button.classList.add(newLogic);
    button.textContent = newLogic.toUpperCase();
    
    // Update hidden inputs for all filters in this group
    group.querySelectorAll('input[name="filter_logic[]"]').forEach(input => {
        input.value = newLogic;
    });
}

function toggleConnectorLogic(button) {
    const isAnd = button.classList.contains('and');
    const newLogic = isAnd ? 'or' : 'and';
    
    button.classList.remove('and', 'or');
    button.classList.add(newLogic);
    button.textContent = newLogic.toUpperCase();
    
    // Update the global group logic
    document.getElementById('groupLogicInput').value = newLogic;
    
    // Update all connectors to be consistent
    document.querySelectorAll('.logic-connector-btn').forEach(btn => {
        btn.classList.remove('and', 'or');
        btn.classList.add(newLogic);
        btn.textContent = newLogic.toUpperCase();
    });
}

// Sort change
document.getElementById('sortSelect')?.addEventListener('change', function() {
    document.getElementById('sortInput').value = this.value;
    document.getElementById('searchForm').submit();
});
</script>
{% endblock %}
