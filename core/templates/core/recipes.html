{% extends "core/base.html" %}
{% load query_params %}

{% block title %}Recipes - Cookmarks{% endblock %}

{% block content %}
<style>
    /* Two-column layout */
    .search-layout {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
    }
    
    /* Results column (left) */
    .results-column {
        min-width: 0;
    }
    
    /* Sidebar (right) */
    .search-sidebar {
        position: sticky;
        top: 1rem;
        height: fit-content;
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
    }
    
    .search-box {
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 12px;
        padding: 1rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        margin-bottom: 1rem;
    }
    
    .search-box-title {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--bs-secondary-color);
        margin-bottom: 0.75rem;
        display: block;
    }
    
    /* Quick search */
    .quick-search-row {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    
    .quick-search-input {
        flex: 1;
        padding: 0.6rem 0.75rem;
        font-size: 0.95rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        background: var(--bs-body-bg);
        color: var(--bs-body-color);
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    
    .quick-search-input:focus {
        outline: none;
        border-color: var(--bs-emphasis-color);
        box-shadow: 0 0 0 3px rgba(var(--bs-emphasis-color-rgb), 0.1);
    }
    
    .search-btn {
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
        font-weight: 500;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: all 0.15s ease;
        white-space: nowrap;
    }
    
    .search-btn-primary {
        background: var(--bs-secondary-bg);
        border: 1px solid var(--bs-border-color);
        color: var(--bs-body-color);
    }
    
    .search-btn-primary:hover {
        background: var(--bs-tertiary-bg);
    }
    
    .search-btn-secondary {
        background: transparent;
        border: 1px solid var(--bs-border-color);
        color: var(--bs-body-color);
    }
    
    .search-btn-secondary:hover {
        background: var(--bs-tertiary-bg);
    }
    
    /* Filter groups */
    .filter-group {
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        background: var(--bs-tertiary-bg);
    }
    
    .filter-group-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    
    .filter-group-label {
        font-size: 0.7rem;
        color: var(--bs-secondary-color);
        flex: 1;
    }
    
    .filter-group-logic {
        padding: 0.2rem 0.4rem;
        font-size: 0.7rem;
        font-weight: 600;
        border: none;
        border-radius: 4px;
        background: var(--bs-secondary-bg);
        color: var(--bs-body-color);
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .filter-group-logic:hover {
        background: var(--bs-tertiary-bg);
    }
    
    .filter-group-logic.and {
        background: var(--bs-success-bg-subtle);
        color: var(--bs-success-text-emphasis);
    }
    
    .filter-group-logic.or {
        background: var(--bs-info-bg-subtle);
        color: var(--bs-info-text-emphasis);
    }
    
    .filter-row {
        display: flex;
        gap: 0.35rem;
        margin-bottom: 0.4rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-row:last-child {
        margin-bottom: 0;
    }
    
    .filter-field-select,
    .filter-operator-select,
    .filter-value-input {
        padding: 0.35rem 0.5rem;
        font-size: 0.8rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 6px;
        background: var(--bs-body-bg);
        color: var(--bs-body-color);
    }
    
    .filter-field-select {
        min-width: 90px;
    }
    
    .filter-operator-select {
        min-width: 85px;
    }
    
    .filter-value-input {
        flex: 1;
        min-width: 80px;
    }
    
    .filter-remove-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        background: var(--bs-tertiary-bg);
        color: var(--bs-secondary-color);
        cursor: pointer;
        transition: all 0.15s ease;
        font-size: 0.9rem;
    }
    
    .filter-remove-btn:hover {
        background: var(--bs-danger);
        color: white;
    }
    
    .filter-add-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.35rem 0.6rem;
        font-size: 0.75rem;
        border: 1px dashed var(--bs-border-color);
        border-radius: 6px;
        background: transparent;
        color: var(--bs-secondary-color);
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .filter-add-btn:hover {
        border-color: var(--bs-emphasis-color);
        color: var(--bs-body-color);
        background: var(--bs-tertiary-bg);
    }
    
    /* Logic connector between groups */
    .logic-connector {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.35rem 0;
    }
    
    .logic-connector-btn {
        padding: 0.2rem 0.6rem;
        font-size: 0.7rem;
        font-weight: 600;
        border: 1px solid var(--bs-border-color);
        border-radius: 12px;
        background: var(--bs-body-bg);
        color: var(--bs-body-color);
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .logic-connector-btn:hover {
        background: var(--bs-tertiary-bg);
    }
    
    .logic-connector-btn.and {
        background: var(--bs-success-bg-subtle);
        border-color: var(--bs-success-border-subtle);
        color: var(--bs-success-text-emphasis);
    }
    
    .logic-connector-btn.or {
        background: var(--bs-info-bg-subtle);
        border-color: var(--bs-info-border-subtle);
        color: var(--bs-info-text-emphasis);
    }
    
    /* AI Prompt */
    .ai-prompt-input {
        width: 100%;
        padding: 0.6rem 0.75rem;
        font-size: 0.9rem;
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        background: var(--bs-body-bg);
        color: var(--bs-body-color);
        transition: border-color 0.15s ease, box-shadow 0.15s ease;
        margin-bottom: 0.5rem;
    }
    
    .ai-prompt-input:focus {
        outline: none;
        border-color: var(--bs-emphasis-color);
        box-shadow: 0 0 0 3px rgba(var(--bs-emphasis-color-rgb), 0.1);
    }
    
    .ai-prompt-btn {
        width: 100%;
        padding: 0.6rem 1rem;
        font-size: 0.85rem;
        font-weight: 500;
        border: 1px solid var(--bs-border-color);
        border-radius: 8px;
        background: var(--bs-secondary-bg);
        color: var(--bs-body-color);
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .ai-prompt-btn:hover:not(:disabled) {
        background: var(--bs-tertiary-bg);
    }
    
    .ai-prompt-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    .ai-prompt-btn.loading {
        position: relative;
    }
    
    .ai-prompt-btn.loading::after {
        content: "";
        position: absolute;
        width: 14px;
        height: 14px;
        margin-left: 6px;
        border: 2px solid transparent;
        border-top-color: var(--bs-body-bg);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .ai-error {
        color: var(--bs-danger);
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }
    
    .ai-hint {
        font-size: 0.75rem;
        color: var(--bs-secondary-color);
        margin-top: 0.5rem;
    }
    
    /* Results header */
    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--bs-border-color);
    }
    
    .results-count {
        font-size: 0.9rem;
        color: var(--bs-secondary-color);
    }
    
    .results-sort {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    /* Recipe result card */
    .result-card {
        display: block;
        background: var(--bs-body-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 10px;
        padding: 1rem 1.25rem;
        margin-bottom: 0.75rem;
        text-decoration: none;
        color: inherit;
        transition: all 0.15s ease;
    }
    
    .result-card:hover {
        border-color: var(--bs-border-color-translucent);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transform: translateY(-1px);
    }
    
    .result-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .result-card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--bs-body-color);
        margin: 0;
    }
    
    .result-card-meta {
        font-size: 0.85rem;
        color: var(--bs-secondary-color);
    }
    
    .result-card-source {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        font-size: 0.8rem;
        color: var(--bs-secondary-color);
        text-align: right;
    }
    
    .result-card-author {
        font-weight: 500;
        color: var(--bs-body-color);
    }
    
    .result-card-highlights {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin-top: 0.75rem;
    }
    
    .highlight-tag {
        display: inline-block;
        background: var(--bs-warning-bg-subtle);
        border: 1px solid var(--bs-warning-border-subtle);
        color: var(--bs-warning-text-emphasis);
        font-size: 0.75rem;
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
    }
    
    .result-card-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin-top: 0.5rem;
    }
    
    .result-keyword {
        display: inline-block;
        background: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color);
        color: var(--bs-body-color);
        font-size: 0.75rem;
        padding: 0.15rem 0.5rem;
        border-radius: 10px;
    }
    
    /* Match highlight in text */
    .match {
        background: var(--bs-warning-bg-subtle);
        padding: 0 0.15rem;
        border-radius: 2px;
    }
    
    /* Initial state (no search yet) */
    .search-initial {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        text-align: center;
        color: var(--bs-secondary-color);
    }
    
    .search-initial-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.4;
    }
    
    .search-initial h2 {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--bs-body-color);
        margin-bottom: 0.5rem;
    }
    
    .search-initial p {
        font-size: 1rem;
        max-width: 400px;
    }
    
    /* Responsive */
    @media (max-width: 900px) {
        .search-layout {
            grid-template-columns: 1fr;
        }
        
        .search-sidebar {
            position: static;
            order: -1;
            max-height: none;
        }
    }
</style>

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">Recipes</h1>
</div>

<div class="search-layout">
    <!-- Results Column (Left) -->
    <div class="results-column">
        {% if has_searched %}
        <div class="results-header">
            <span class="results-count">
                {{ recipes.paginator.count }} result{{ recipes.paginator.count|pluralize }}
                {% if query %}for "{{ query }}"{% endif %}
            </span>
            <div class="results-sort">
            <span class="text-secondary" style="font-size: 0.85rem;">Sort:</span>
                <select class="form-select form-select-sm" style="width: auto; font-size: 0.85rem;" id="sortSelect">
                    {% if vector_ids %}<option value="relevance" {% if sort_by == 'relevance' %}selected{% endif %}>Relevance</option>{% endif %}
                    <option value="recent" {% if sort_by == 'recent' %}selected{% endif %}>Recently Added</option>
                    <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name A-Z</option>
                    <option value="author" {% if sort_by == 'author' %}selected{% endif %}>Author</option>
                    <option value="book" {% if sort_by == 'book' %}selected{% endif %}>Book</option>
                    <option value="order" {% if sort_by == 'order' %}selected{% endif %}>Book Order</option>
                    {% if selected_lists|length == 1 %}<option value="list_order" {% if sort_by == 'list_order' %}selected{% endif %}>List Order</option>{% endif %}
                    <option value="random" {% if sort_by == 'random' %}selected{% endif %}>Random</option>
                </select>
            </div>
        </div>
        
        {% for recipe in recipes %}
        <a href="{% url 'recipe_detail' recipe.id %}?{{ recipe_context_params }}" class="result-card">
            <div class="result-card-header">
                <div>
                    <h3 class="result-card-title">{{ recipe.clean_name }}</h3>
                </div>
                <div class="result-card-source">
                    <span class="result-card-author">{{ recipe.book.author }}</span>
                    <span>{{ recipe.book.clean_title }}</span>
                </div>
            </div>
            {% if recipe.match_highlights %}
            <div class="result-card-highlights">
                {% for highlight in recipe.match_highlights %}
                <span class="highlight-tag">{{ highlight }}</span>
                {% endfor %}
            </div>
            {% endif %}
            {% if recipe.keywords.all %}
            <div class="result-card-keywords">
                {% for keyword in recipe.keywords.all|slice:":8" %}
                <span class="result-keyword">{{ keyword.name }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </a>
        {% empty %}
        <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div class="empty-state-title">No recipes found</div>
            <p>Try adjusting your search terms or filters</p>
        </div>
        {% endfor %}
        
        <!-- Pagination -->
        {% if recipes.has_other_pages %}
        <nav class="page-pagination" aria-label="Search results pagination">
            {% if recipes.has_previous %}
            <a href="{% preserve_query_params page=1 %}" class="pagination-btn" title="First page">¬´¬´</a>
            <a href="{% preserve_query_params page=recipes.previous_page_number %}" class="pagination-btn" title="Previous page">‚Äπ</a>
            {% endif %}
            
            <span class="pagination-info">
                Page {{ recipes.number }} of {{ recipes.paginator.num_pages }}
            </span>
            
            {% if recipes.has_next %}
            <a href="{% preserve_query_params page=recipes.next_page_number %}" class="pagination-btn" title="Next page">‚Ä∫</a>
            <a href="{% preserve_query_params page=recipes.paginator.num_pages %}" class="pagination-btn" title="Last page">¬ª¬ª</a>
            {% endif %}
        </nav>
        {% endif %}
        {% else %}
        <!-- Initial state - no search performed yet -->
        <div class="search-initial">
            <div class="search-initial-icon">üç≥</div>
            <h2>Browse your recipes</h2>
            <p>Use the search box to find recipes in your collection.<br>Try the powerful AI search feature to go even deeper.</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Search Sidebar (Right)-->
    <div class="search-sidebar">
        <form method="get" action="{% url 'recipes' %}" id="searchForm">
            <!-- Quick Search Box -->
            <div class="search-box">
                <div class="search-box-title">Quick Search</div>
                <div class="quick-search-row">
                    <input type="text" 
                           class="quick-search-input" 
                           name="q" 
                           value="{{ query }}"
                           autofocus>
                </div>
                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                    {% if query %}
                    <a href="{% url 'recipes' %}" class="search-btn search-btn-secondary" style="flex: 1; text-align: center;">Clear</a>
                    {% endif %}
                    <button type="submit" class="search-btn search-btn-primary" style="{% if not query %}width: 100%;{% else %}flex: 1;{% endif %}">Search</button>
                </div>
            </div>
            
            <!-- AI-Powered Vector Search -->
            <div class="search-box">
                <div class="search-box-title">AI-Powered Smart Search ‚ú®</div>
                <!-- <div class="ai-hint">Uses AI to search deeper and find dishes related to your search term</div> -->
                <input type="text" 
                       class="ai-prompt-input" 
                       id="aiPromptInput"
                       placeholder="e.g. 'salads with cheese and nuts'"{% if vector_ids %} value="{{ request.GET.ai_query }}"{% endif %}>
                <button type="button" class="ai-prompt-btn" id="aiPromptBtn" onclick="searchWithAI()">
                    Search
                </button>
                <div id="aiError" class="ai-error" style="display: none;"></div>
                {% if vector_ids %}
                <div style="margin-top: 0.5rem;">
                    <a href="{% url 'recipes' %}" class="search-btn search-btn-secondary" style="width: 100%; text-align: center; display: block;">Clear AI Search</a>
                </div>
                {% endif %}
            </div>

            <!-- Filter Builder -->
            <div class="search-box">
                <div class="search-box-title">Filters</div>
                <div id="filterGroups">
                    {% if filters %}
                        {% for group in filters %}
                        <div class="filter-group" data-group-index="{{ forloop.counter0 }}">
                            <div class="filter-group-header">
                                <button type="button" class="filter-group-logic {{ group.logic }}" onclick="toggleGroupLogic(this)">{{ group.logic|upper }}</button>
                                <span class="filter-group-label">within this group</span>
                                <button type="button" class="filter-remove-btn" onclick="removeGroup(this)" title="Remove group">√ó</button>
                            </div>
                            {% for condition in group.conditions %}
                            <div class="filter-row">
                                <select class="filter-field-select" name="filter_field[]">
                                    <option value="name" {% if condition.field == 'name' %}selected{% endif %}>Name</option>
                                    <option value="ingredients" {% if condition.field == 'ingredients' %}selected{% endif %}>Ingredients</option>
                                    <option value="instructions" {% if condition.field == 'instructions' %}selected{% endif %}>Instructions</option>
                                    <option value="keywords" {% if condition.field == 'keywords' %}selected{% endif %}>Keywords</option>
                                    <option value="author" {% if condition.field == 'author' %}selected{% endif %}>Author</option>
                                    <option value="book" {% if condition.field == 'book' %}selected{% endif %}>Book</option>
                                </select>
                                <select class="filter-operator-select" name="filter_op[]">
                                    <option value="contains" {% if condition.op == 'contains' %}selected{% endif %}>contains</option>
                                    <option value="not_contains" {% if condition.op == 'not_contains' %}selected{% endif %}>doesn't contain</option>
                                    <option value="equals" {% if condition.op == 'equals' %}selected{% endif %}>equals</option>
                                    <option value="starts" {% if condition.op == 'starts' %}selected{% endif %}>starts with</option>
                                </select>
                                <input type="text" class="filter-value-input" name="filter_value[]" value="{{ condition.value }}" placeholder="Value...">
                                <input type="hidden" name="filter_group[]" value="{{ forloop.parentloop.counter0 }}">
                                <input type="hidden" name="filter_logic[]" value="{{ group.logic }}">
                                <button type="button" class="filter-remove-btn" onclick="removeFilter(this)" title="Remove filter">√ó</button>
                            </div>
                            {% endfor %}
                            <button type="button" class="filter-add-btn mt-2" onclick="addFilterToGroup(this.parentElement)">+ Add condition</button>
                        </div>
                        {% if not forloop.last %}
                        <div class="logic-connector">
                            <button type="button" class="logic-connector-btn {{ group_logic|default:'or' }}" onclick="toggleConnectorLogic(this)">{{ group_logic|default:'OR'|upper }}</button>
                        </div>
                        {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                <input type="hidden" name="group_logic" id="groupLogicInput" value="{{ group_logic|default:'or' }}">
                <button type="button" class="filter-add-btn {% if filters %}mt-2{% endif %}" onclick="addFilterGroup()">+ Add filter group</button>
            </div>
            
            <!-- Sort (hidden) -->
            <input type="hidden" name="sort" id="sortInput" value="{{ sort_by|default:'relevance' }}">
            <input type="hidden" name="vector_ids" id="vectorIdsInput" value="{{ vector_ids }}">
        </form>
    </div>
</div>

<script>
let groupCounter = {{ filters|length|default:0 }};

function createFilterRow(groupIndex, logic) {
    const row = document.createElement('div');
    row.className = 'filter-row';
    row.innerHTML = `
        <select class="filter-field-select" name="filter_field[]">
            <option value="name">Name</option>
            <option value="ingredients">Ingredients</option>
            <option value="instructions">Instructions</option>
            <option value="keywords">Keywords</option>
            <option value="author">Author</option>
            <option value="book">Book</option>
        </select>
        <select class="filter-operator-select" name="filter_op[]">
            <option value="contains">contains</option>
            <option value="not_contains">doesn't contain</option>
            <option value="equals">equals</option>
            <option value="starts">starts with</option>
        </select>
        <input type="text" class="filter-value-input" name="filter_value[]" placeholder="Value...">
        <input type="hidden" name="filter_group[]" value="${groupIndex}">
        <input type="hidden" name="filter_logic[]" value="${logic}">
        <button type="button" class="filter-remove-btn" onclick="removeFilter(this)" title="Remove filter">√ó</button>
    `;
    return row;
}

function addFilterGroup() {
    const container = document.getElementById('filterGroups');
    const existingGroups = container.querySelectorAll('.filter-group');
    
    // Add logic connector if not the first group
    if (existingGroups.length > 0) {
        const connector = document.createElement('div');
        connector.className = 'logic-connector';
        const currentLogic = document.getElementById('groupLogicInput').value || 'or';
        connector.innerHTML = `<button type="button" class="logic-connector-btn ${currentLogic}" onclick="toggleConnectorLogic(this)">${currentLogic.toUpperCase()}</button>`;
        container.appendChild(connector);
    }
    
    const group = document.createElement('div');
    group.className = 'filter-group';
    group.dataset.groupIndex = groupCounter;
    group.innerHTML = `
        <div class="filter-group-header">
            <button type="button" class="filter-group-logic and" onclick="toggleGroupLogic(this)">AND</button>
            <span class="filter-group-label">within this group</span>
            <button type="button" class="filter-remove-btn" onclick="removeGroup(this)" title="Remove group">√ó</button>
        </div>
    `;
    
    const filterRow = createFilterRow(groupCounter, 'and');
    group.appendChild(filterRow);
    
    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'filter-add-btn';
    addBtn.textContent = '+ Add condition';
    addBtn.onclick = function() { addFilterToGroup(group); };
    group.appendChild(addBtn);
    
    container.appendChild(group);
    groupCounter++;
}

function addFilterToGroup(groupElement) {
    const groupIndex = groupElement.dataset.groupIndex;
    const logicBtn = groupElement.querySelector('.filter-group-logic');
    const logic = logicBtn ? logicBtn.textContent.toLowerCase() : 'and';
    const addBtn = groupElement.querySelector('.filter-add-btn');
    const filterRow = createFilterRow(groupIndex, logic);
    groupElement.insertBefore(filterRow, addBtn);
}

function removeFilter(button) {
    const row = button.closest('.filter-row');
    const group = row.closest('.filter-group');
    row.remove();
    
    // If no more filter rows in group, remove the group
    if (group.querySelectorAll('.filter-row').length === 0) {
        removeGroupElement(group);
    }
}

function removeGroup(button) {
    const group = button.closest('.filter-group');
    removeGroupElement(group);
}

function removeGroupElement(group) {
    const container = document.getElementById('filterGroups');
    const groups = Array.from(container.querySelectorAll('.filter-group'));
    const index = groups.indexOf(group);
    
    // Remove associated connector
    const connectors = container.querySelectorAll('.logic-connector');
    if (index > 0 && connectors[index - 1]) {
        connectors[index - 1].remove();
    } else if (index === 0 && connectors[0]) {
        connectors[0].remove();
    }
    
    group.remove();
}

function toggleGroupLogic(button) {
    const group = button.closest('.filter-group');
    const isAnd = button.classList.contains('and');
    const newLogic = isAnd ? 'or' : 'and';
    
    button.classList.remove('and', 'or');
    button.classList.add(newLogic);
    button.textContent = newLogic.toUpperCase();
    
    // Update hidden inputs for all filters in this group
    group.querySelectorAll('input[name="filter_logic[]"]').forEach(input => {
        input.value = newLogic;
    });
}

function toggleConnectorLogic(button) {
    const isAnd = button.classList.contains('and');
    const newLogic = isAnd ? 'or' : 'and';
    
    button.classList.remove('and', 'or');
    button.classList.add(newLogic);
    button.textContent = newLogic.toUpperCase();
    
    // Update the global group logic
    document.getElementById('groupLogicInput').value = newLogic;
    
    // Update all connectors to be consistent
    document.querySelectorAll('.logic-connector-btn').forEach(btn => {
        btn.classList.remove('and', 'or');
        btn.classList.add(newLogic);
        btn.textContent = newLogic.toUpperCase();
    });
}

// Sort change
document.getElementById('sortSelect')?.addEventListener('change', function() {
    document.getElementById('sortInput').value = this.value;
    document.getElementById('searchForm').submit();
});

// AI Vector Search
async function searchWithAI() {
    const promptInput = document.getElementById('aiPromptInput');
    const btn = document.getElementById('aiPromptBtn');
    const errorDiv = document.getElementById('aiError');
    
    const prompt = promptInput.value.trim();
    if (!prompt) {
        showAIError('Please enter a search prompt');
        return;
    }
    
    // Show loading state
    btn.disabled = true;
    btn.classList.add('loading');
    btn.textContent = 'Searching...';
    errorDiv.style.display = 'none';
    
    try {
        const response = await fetch('{% url "ai_search" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ prompt: prompt, limit: 1000 })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            showAIError(data.error || 'Search failed');
            return;
        }
        
        if (data.recipe_ids && data.recipe_ids.length > 0) {
            // Build URL with vector search results
            const params = new URLSearchParams();
            params.set('vector_ids', data.recipe_ids.join(','));
            params.set('sort', 'relevance');
            params.set('ai_query', prompt);
            window.location.href = '{% url "recipes" %}?' + params.toString();
        } else {
            showAIError('No matching recipes found');
        }
        
    } catch (err) {
        showAIError('Network error: ' + err.message);
    } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = 'Search';
    }
}

function showAIError(message) {
    const errorDiv = document.getElementById('aiError');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

// Allow Enter key to trigger AI search
document.getElementById('aiPromptInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        searchWithAI();
    }
});
</script>
{% endblock %}
