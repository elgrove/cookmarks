{% extends "core/base.html" %}
{% load query_params %}

{% block title %}Recipes - Cookmarks{% endblock %}

{% block content %}
<style>
    /* Recipe card grid */
    .recipe-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.25rem;
    }
    
    @media (max-width: 992px) {
        .recipe-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    
    @media (max-width: 576px) {
        .recipe-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .recipe-card {
        display: flex;
        flex-direction: column;
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        text-decoration: none;
        color: inherit;
        transition: all 0.2s ease;
        overflow: hidden;
        height: 100%;
        min-height: 180px;
    }
    
    .recipe-card:hover {
        background: #fafbfc;
        border-color: #dee2e6;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        transform: translateY(-2px);
    }
    
    .recipe-card-content {
        display: flex;
        flex-direction: column;
        padding: 1.25rem;
        flex: 1;
    }
    
    .recipe-name {
        font-size: 1.15rem;
        font-weight: 600;
        color: #212529;
        margin: 0 0 0.75rem;
        line-height: 1.35;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .recipe-meta {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
        font-size: 0.95rem;
        color: #6c757d;
        margin-bottom: auto;
    }
    
    .recipe-author {
        font-weight: 500;
        color: #495057;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .recipe-book {
        color: #6c757d;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 0.9rem;
    }
    
    .recipe-keywords {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        margin-top: 1rem;
        padding-top: 0.75rem;
        border-top: 1px solid #f0f1f2;
    }
    
    .recipe-keyword {
        display: inline-block;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        color: #495057;
        font-size: 0.8rem;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        transition: all 0.15s ease;
    }
    
    .recipe-card:hover .recipe-keyword {
        background: #f0f1f2;
        border-color: #dee2e6;
    }
    
    .empty-state-card {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 12px;
    }
</style>

<!-- Page Header -->
<div class="page-header">
    <h1 class="page-title">{% if selected_lists|length == 1 %}{% for list in all_lists %}{% if list.id|stringformat:"s" in selected_lists %}{{ list.name }}{% endif %}{% endfor %}{% else %}Recipes{% endif %}</h1>
</div>

<!-- Filter Form -->
<form method="get" action="{% url 'recipes' %}" id="filterForm" data-loading>
    <!-- Main Filter Bar -->
    <div class="filter-bar">
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <!-- Sort -->
            <select class="form-select" name="sort" style="width: auto; min-width: 160px;" id="sortSelect">
                <option value="random" {% if sort_by == 'random' %}selected{% endif %}>Random</option>
                <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name A-Z</option>
                <option value="author" {% if sort_by == 'author' %}selected{% endif %}>Author A-Z</option>
                <option value="book" {% if sort_by == 'book' %}selected{% endif %}>Book Title</option>
                <option value="order" {% if sort_by == 'order' %}selected{% endif %}>Book Order</option>
            </select>
            
            <!-- Search -->
            <div class="flex-grow-1" style="max-width: 280px; min-width: 150px;">
                <input type="text" class="form-control" name="search" placeholder="Search recipes..." value="{{ search }}">
            </div>
            
            <!-- Book Filter Toggle -->
            <button type="button" class="btn filter-btn filter-btn-secondary" 
                    data-bs-toggle="collapse" data-bs-target="#bookFilterPanel"
                    aria-label="Filter by book">
                Book
                {% if selected_books|length > 0 %}
                <span class="filter-badge">{{ selected_books|length }}</span>
                {% endif %}
            </button>
            
            <!-- Author Filter Toggle -->
            <button type="button" class="btn filter-btn filter-btn-secondary" 
                    data-bs-toggle="collapse" data-bs-target="#authorFilterPanel"
                    aria-label="Filter by author">
                Author
                {% if selected_authors|length > 0 %}
                <span class="filter-badge">{{ selected_authors|length }}</span>
                {% endif %}
            </button>
            
            <!-- Keyword Filter Toggle -->
            <button type="button" class="btn filter-btn filter-btn-secondary" 
                    data-bs-toggle="collapse" data-bs-target="#keywordFilterPanel"
                    aria-label="Filter by keyword">
                Keyword
                {% if selected_keywords|length > 0 %}
                <span class="filter-badge">{{ selected_keywords|length }}</span>
                {% endif %}
            </button>
            
            <!-- List Filter Toggle -->
            <button type="button" class="btn filter-btn filter-btn-secondary" 
                    data-bs-toggle="collapse" data-bs-target="#listFilterPanel"
                    aria-label="Filter by list">
                List
                {% if selected_lists|length > 0 %}
                <span class="filter-badge">{{ selected_lists|length }}</span>
                {% endif %}
            </button>
            
            <!-- Actions -->
            <div class="ms-auto d-flex gap-2 align-items-center">
                <span class="filter-count d-none d-md-inline">{{ page_obj.paginator.count }} recipe{{ page_obj.paginator.count|pluralize }}</span>
                <button type="submit" class="btn filter-btn filter-btn-primary">Apply</button>
                <a href="{% url 'recipes' %}" class="btn filter-btn filter-btn-secondary">Clear</a>
            </div>
        </div>
    </div>
    
    <!-- Active Filters Pills -->
    {% if selected_lists or selected_books or selected_authors or selected_keywords %}
    <div class="active-filters">
        {% for list in all_lists %}
            {% if list.id|stringformat:"s" in selected_lists %}
            <span class="filter-pill">
                üìã {{ list.name }}
                <button type="button" class="filter-pill-close" 
                        onclick="document.getElementById('list_{{ list.id }}').checked = false; document.getElementById('filterForm').submit();"
                        aria-label="Remove list filter">
                    √ó
                </button>
            </span>
            {% endif %}
        {% endfor %}
        {% for book in all_books %}
            {% if book.id|stringformat:"s" in selected_books %}
            <span class="filter-pill">
                üìö {{ book.clean_title|truncatechars:30 }}
                <button type="button" class="filter-pill-close" 
                        onclick="document.getElementById('book_{{ book.id }}').checked = false; document.getElementById('filterForm').submit();"
                        aria-label="Remove book filter">
                    √ó
                </button>
            </span>
            {% endif %}
        {% endfor %}
        {% for author in selected_authors %}
        <span class="filter-pill">
            üë§ {{ author }}
            <button type="button" class="filter-pill-close"
                    onclick="document.querySelector('input[value=\'{{ author }}\'].author-checkbox').checked = false; document.getElementById('filterForm').submit();"
                    aria-label="Remove author filter">
                √ó
            </button>
        </span>
        {% endfor %}
        {% for keyword in selected_keywords %}
        <span class="filter-pill">
            üè∑Ô∏è {{ keyword }}
            <button type="button" class="filter-pill-close"
                    onclick="document.querySelector('input[value=\'{{ keyword }}\'].keyword-checkbox').checked = false; document.getElementById('filterForm').submit();"
                    aria-label="Remove keyword filter">
                √ó
            </button>
        </span>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Book Filter Panel -->
    <div class="collapse" id="bookFilterPanel">
        <div class="filter-dropdown">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="filter-dropdown-title">Filter by Book</span>
                <div class="d-flex gap-3 align-items-center">
                    <input type="text" class="form-control form-control-sm" id="bookSearch" 
                           placeholder="Search books..." style="max-width: 180px; font-size: 0.8rem;">
                    <label class="form-check-label d-flex align-items-center gap-2" style="font-size: 0.8rem; cursor: pointer;">
                        <input class="form-check-input" type="checkbox" id="selectAllBooks" style="margin: 0;">
                        Select visible
                    </label>
                </div>
            </div>
            <div class="filter-grid">
                {% for book in all_books %}
                <label class="filter-checkbox-label book-item">
                    <input class="form-check-input book-checkbox" type="checkbox" name="selected_books[]" 
                           value="{{ book.id }}" id="book_{{ book.id }}"
                           {% if book.id|stringformat:"s" in selected_books %}checked{% endif %}>
                    <span class="filter-name">{{ book.clean_title|truncatechars:35 }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Author Filter Panel -->
    <div class="collapse" id="authorFilterPanel">
        <div class="filter-dropdown">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="filter-dropdown-title">Filter by Author</span>
                <div class="d-flex gap-3 align-items-center">
                    <input type="text" class="form-control form-control-sm" id="authorSearch" 
                           placeholder="Search authors..." style="max-width: 180px; font-size: 0.8rem;">
                    <label class="form-check-label d-flex align-items-center gap-2" style="font-size: 0.8rem; cursor: pointer;">
                        <input class="form-check-input" type="checkbox" id="selectAllAuthors" style="margin: 0;">
                        Select visible
                    </label>
                </div>
            </div>
            <div class="filter-grid">
                {% for author in all_authors %}
                <label class="filter-checkbox-label author-item">
                    <input class="form-check-input author-checkbox" type="checkbox" name="selected_authors[]" 
                           value="{{ author }}" id="author_{{ forloop.counter }}"
                           {% if author in selected_authors %}checked{% endif %}>
                    <span class="filter-name">{{ author }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Keyword Filter Panel -->
    <div class="collapse" id="keywordFilterPanel">
        <div class="filter-dropdown">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="filter-dropdown-title">Filter by Keyword</span>
                <div class="d-flex gap-3 align-items-center">
                    <input type="text" class="form-control form-control-sm" id="keywordSearch" 
                           placeholder="Search keywords..." style="max-width: 180px; font-size: 0.8rem;">
                    <label class="form-check-label d-flex align-items-center gap-2" style="font-size: 0.8rem; cursor: pointer;">
                        <input class="form-check-input" type="checkbox" id="selectAllKeywords" style="margin: 0;">
                        Select visible
                    </label>
                </div>
            </div>
            <div class="filter-grid">
                {% for keyword in all_keywords %}
                <label class="filter-checkbox-label keyword-item">
                    <input class="form-check-input keyword-checkbox" type="checkbox" name="selected_keywords[]" 
                           value="{{ keyword.name }}" id="keyword_{{ forloop.counter }}"
                           {% if keyword.name in selected_keywords %}checked{% endif %}>
                    <span class="filter-name">{{ keyword.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- List Filter Panel -->
    <div class="collapse" id="listFilterPanel">
        <div class="filter-dropdown">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="filter-dropdown-title">Filter by List</span>
                <div class="d-flex gap-3 align-items-center">
                    <input type="text" class="form-control form-control-sm" id="listSearch" 
                           placeholder="Search lists..." style="max-width: 180px; font-size: 0.8rem;">
                    <label class="form-check-label d-flex align-items-center gap-2" style="font-size: 0.8rem; cursor: pointer;">
                        <input class="form-check-input" type="checkbox" id="selectAllLists" style="margin: 0;">
                        Select visible
                    </label>
                </div>
            </div>
            <div class="filter-grid">
                {% for list in all_lists %}
                <label class="filter-checkbox-label list-item">
                    <input class="form-check-input list-checkbox" type="checkbox" name="selected_lists[]" 
                           value="{{ list.id }}" id="list_{{ list.id }}"
                           {% if list.id|stringformat:"s" in selected_lists %}checked{% endif %}>
                    <span class="filter-name">{{ list.name }}</span>
                </label>
                {% endfor %}
            </div>
        </div>
    </div>
</form>

<!-- Recipe Count (Mobile) -->
<div class="d-md-none text-center mb-3">
    <span class="filter-count">{{ page_obj.paginator.count }} recipe{{ page_obj.paginator.count|pluralize }}</span>
</div>

<!-- Recipe Grid -->
<div class="recipe-grid">
    {% for recipe in recipes %}
    <a href="{% url 'recipe_detail' recipe.id %}" class="recipe-card">
        <div class="recipe-card-content">
            <h3 class="recipe-name">{{ recipe.clean_name }}</h3>
            <div class="recipe-meta">
                <span class="recipe-author">{{ recipe.book.author }}</span>
                <span class="recipe-book">{{ recipe.book.clean_title }}</span>
            </div>
            {% if recipe.keywords.all %}
            <div class="recipe-keywords">
                {% for keyword in recipe.keywords.all|slice:":6" %}
                <span class="recipe-keyword">{{ keyword.name }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </a>
    {% empty %}
    <div class="empty-state empty-state-card" style="grid-column: 1 / -1;">
        <div class="empty-state-icon">üç≥</div>
        <div class="empty-state-title">No recipes found</div>
        <p>Try adjusting your filters or search terms.</p>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if page_obj.has_other_pages %}
<nav class="page-pagination" aria-label="Recipe pagination">
    {% if page_obj.has_previous %}
    <a href="{% preserve_query_params page=1 %}" class="pagination-btn" title="First page">
        ¬´¬´
    </a>
    <a href="{% preserve_query_params page=page_obj.previous_page_number %}" class="pagination-btn" title="Previous page">
        ‚Äπ
    </a>
    {% endif %}
    
    <span class="pagination-info">
        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
    </span>
    
    {% if page_obj.has_next %}
    <a href="{% preserve_query_params page=page_obj.next_page_number %}" class="pagination-btn" title="Next page">
        ‚Ä∫
    </a>
    <a href="{% preserve_query_params page=page_obj.paginator.num_pages %}" class="pagination-btn" title="Last page">
        ¬ª¬ª
    </a>
    {% endif %}
</nav>
{% endif %}

<script>
document.getElementById('sortSelect').addEventListener('change', function() {
    document.getElementById('filterForm').submit();
});

function setupFilterPanel(searchId, itemClass, checkboxClass, selectAllId) {
    const searchInput = document.getElementById(searchId);
    const selectAll = document.getElementById(selectAllId);
    
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            document.querySelectorAll('.' + itemClass).forEach(item => {
                const label = item.querySelector('.filter-name').textContent.toLowerCase();
                item.style.display = label.includes(searchTerm) ? '' : 'none';
            });
        });
    }
    
    if (selectAll) {
        selectAll.addEventListener('change', function(e) {
            document.querySelectorAll('.' + checkboxClass).forEach(checkbox => {
                if (checkbox.closest('.' + itemClass).style.display !== 'none') {
                    checkbox.checked = e.target.checked;
                }
            });
        });
    }
}

setupFilterPanel('bookSearch', 'book-item', 'book-checkbox', 'selectAllBooks');
setupFilterPanel('authorSearch', 'author-item', 'author-checkbox', 'selectAllAuthors');
setupFilterPanel('keywordSearch', 'keyword-item', 'keyword-checkbox', 'selectAllKeywords');
setupFilterPanel('listSearch', 'list-item', 'list-checkbox', 'selectAllLists');
</script>
{% endblock %}
